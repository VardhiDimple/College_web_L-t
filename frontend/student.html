<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #22c55e 0, #065f46 45%, #020617 100%);
      min-height: 100vh;
      padding: 2rem 0;
      color: #e5e7eb;
    }
    .dash-card {
      background: rgba(15,23,42,0.9);
      border-radius: 1rem;
      box-shadow: 0 20px 30px rgba(0,0,0,0.4);
      padding: 1.75rem;
      margin-bottom: 1.5rem;
    }
    .avatar {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #22c55e;
    }
    .chat-floating {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: #22c55e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 15px 30px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
<div class="container">
  <!-- HEADER -->
  <div class="dash-card mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
      <div class="d-flex align-items-center gap-3">
        <img id="stuPhoto" class="avatar"
             src="https://api.dicebear.com/9.x/initials/svg?seed=Student" alt="Student" />
        <div>
          <h3 class="mb-1">Welcome, <span id="stuNameLabel">Student</span> üëã</h3>
          <div class="small text-secondary" id="stuMeta">Dept ¬∑ Roll ¬∑ Year</div>
        </div>
      </div>
      <div class="mt-3 mt-md-0">
        <button class="btn btn-outline-light btn-sm" onclick="openProfileModal()">Edit Profile</button>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Grades + CGPA -->
    <div class="col-lg-7">
      <div class="dash-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">üìö Grades & CGPA</h5>
          <button class="btn btn-sm btn-outline-light" onclick="addGradeRow()">+ Add Course</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-dark align-middle mb-2" id="gradesTable">
            <thead>
            <tr>
              <th>Course Code</th>
              <th>Course Name</th>
              <th>Credits</th>
              <th>Grade (O, A+, A, B+,...)</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">CGPA: <span id="cgpaValue">0.00</span></div>
          <div class="small text-secondary">Changes are saved locally.</div>
        </div>
      </div>

      <!-- Marks from faculty -->
      <div class="dash-card">
        <h5 class="mb-3">üßÆ Marks & Grades (from Faculty)</h5>
        <div class="table-responsive">
          <table class="table table-sm table-dark mb-2">
            <thead>
            <tr>
              <th>Subject</th>
              <th>Marks</th>
              <th>Max</th>
              <th>Grade</th>
            </tr>
            </thead>
            <tbody id="marksTable"></tbody>
          </table>
        </div>
        <div class="small text-secondary">
          Marks appear once faculty saves them in their portal.
        </div>
      </div>
    </div>

    <!-- Attendance overview -->
    <div class="col-lg-5">
      <div class="dash-card">
        <h5 class="mb-3">üìä Attendance Overview</h5>
        <canvas id="attendanceChart" height="180"></canvas>
        <div id="attSummary" class="mt-3 small"></div>
        <div class="mt-3 d-flex flex-wrap gap-2">
          <button class="btn btn-success btn-sm" onclick="openAttendanceDetails()">View Details</button>
          <button class="btn btn-outline-info btn-sm" onclick="openProjects()">View Projects</button>
          <button class="btn btn-outline-warning btn-sm" onclick="openFinance()">Financial Records</button>
          <button class="btn btn-outline-light btn-sm" onclick="scrollToEvents()">Events & Timetable</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects, Finance, Events -->
  <div class="row">
    <div class="col-lg-6">
      <div class="dash-card">
        <h5 class="mb-3">üìå Projects & Deadlines</h5>
        <ul id="projectList" class="list-group list-group-flush small"></ul>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="dash-card">
        <h5 class="mb-3">üí∞ Financial Summary</h5>
        <table class="table table-sm table-dark mb-2">
          <thead>
          <tr>
            <th>Term</th>
            <th>Fees</th>
            <th>Paid</th>
            <th>Due</th>
          </tr>
          </thead>
          <tbody id="financeTable"></tbody>
        </table>
        <div class="small text-secondary">* Demo data; can connect to backend later.</div>
      </div>
    </div>
  </div>

  <!-- Events -->
  <div class="row">
    <div class="col-12">
      <div class="dash-card" id="eventsSection">
        <h5 class="mb-3">üóìÔ∏è Events & Timetable</h5>
        <ul id="eventList" class="list-group list-group-flush small"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Floating chat button -->
<div class="chat-floating" onclick="openChat()" title="Open Chat">
  üí¨
</div>

<!-- Simple profile modal -->
<div id="profileModal" class="modal-backdrop d-none">
  <div class="modal-card">
    <h5>Edit Profile</h5>
    <div class="mb-2">
      <label class="form-label small">Name</label>
      <input id="editName" class="form-control form-control-sm" />
    </div>
    <div class="mb-2">
      <label class="form-label small">Roll No</label>
      <input id="editRoll" class="form-control form-control-sm" />
    </div>
    <div class="mb-2">
      <label class="form-label small">Department</label>
      <input id="editDept" class="form-control form-control-sm" />
    </div>
    <div class="mb-2">
      <label class="form-label small">Year</label>
      <input id="editYear" class="form-control form-control-sm" />
    </div>
    <div class="mb-3">
      <label class="form-label small">Photo URL</label>
      <input id="editPhoto" class="form-control form-control-sm"
             placeholder="Paste image URL or keep blank" />
    </div>
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-sm btn-outline-secondary" onclick="closeProfileModal()">Cancel</button>
      <button class="btn btn-sm btn-success" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<script src="assets/app.js"></script>
<script>
  const STUDENT_PROFILE_KEY = "portal_student_profile";
  const STUDENT_GRADES_KEY = "portal_student_grades";
  const STUDENT_FINANCE_KEY = "portal_student_finance";
  const STUDENT_PROJECTS_KEY = "portal_student_projects";
  const EVENTS_KEY = "portal_events";
  const ATT_KEY = "portal_attendance";
  const MARK_KEY = "portal_marks";

  let attendanceChart;

  document.addEventListener("DOMContentLoaded", () => {
    const auth = requireAuth("student");
    initProfile(auth);
    initGrades();
    initAttendance(auth);
    initProjects();
    initFinance();
    initEvents();
    initMarks(auth);
  });

  function logout() {
    localStorage.removeItem(STORAGE_AUTH_KEY);
    window.location.href = "index.html";
  }

  // ------- PROFILE -------
  function getStoredProfile() {
    const raw = localStorage.getItem(STUDENT_PROFILE_KEY);
    return raw ? JSON.parse(raw) : null;
  }
  function saveStoredProfile(p) {
    localStorage.setItem(STUDENT_PROFILE_KEY, JSON.stringify(p));
  }

  function initProfile(auth) {
    let prof = getStoredProfile() || {
      name: auth.name || auth.email.split("@")[0],
      rollNo: "CSE000",
      dept: "CSE",
      year: "3",
      photo: ""
    };
    saveStoredProfile(prof);
    document.getElementById("stuNameLabel").textContent = prof.name;
    document.getElementById("stuMeta").textContent =
      `${prof.dept} ¬∑ ${prof.rollNo} ¬∑ Year ${prof.year}`;
    if (prof.photo) {
      document.getElementById("stuPhoto").src = prof.photo;
    }
  }

  function openProfileModal() {
    const prof = getStoredProfile();
    document.getElementById("editName").value = prof?.name || "";
    document.getElementById("editRoll").value = prof?.rollNo || "";
    document.getElementById("editDept").value = prof?.dept || "";
    document.getElementById("editYear").value = prof?.year || "";
    document.getElementById("editPhoto").value = prof?.photo || "";
    document.getElementById("profileModal").classList.remove("d-none");
  }
  function closeProfileModal() {
    document.getElementById("profileModal").classList.add("d-none");
  }
  function saveProfile() {
    const prof = {
      name: document.getElementById("editName").value.trim(),
      rollNo: document.getElementById("editRoll").value.trim(),
      dept: document.getElementById("editDept").value.trim(),
      year: document.getElementById("editYear").value.trim(),
      photo: document.getElementById("editPhoto").value.trim()
    };
    saveStoredProfile(prof);
    closeProfileModal();
    initProfile(getAuth());
  }

  // ------- GRADES + CGPA (manual table, no delete icon) -------
  function getStoredGrades() {
    const raw = localStorage.getItem(STUDENT_GRADES_KEY);
    if (raw) return JSON.parse(raw);
    const demo = [
      { code: "CSE101", name: "Python Programming", credits: 4, grade: "A+" },
      { code: "CSE102", name: "Java Programming", credits: 3, grade: "A" }
    ];
    localStorage.setItem(STUDENT_GRADES_KEY, JSON.stringify(demo));
    return demo;
  }
  function saveStoredGrades(g) {
    localStorage.setItem(STUDENT_GRADES_KEY, JSON.stringify(g));
  }

  function initGrades() {
    const tbody = document.querySelector("#gradesTable tbody");
    tbody.innerHTML = "";
    const grades = getStoredGrades();
    grades.forEach((g) => addGradeRow(g));
    updateCGPA();
  }

  function addGradeRow(data = { code: "", name: "", credits: 3, grade: "A" }) {
    const tbody = document.querySelector("#gradesTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" value="${data.code}"></td>
      <td><input class="form-control form-control-sm" value="${data.name}"></td>
      <td><input class="form-control form-control-sm" value="${data.credits}"></td>
      <td><input class="form-control form-control-sm" value="${data.grade}"></td>
    `;
    tbody.appendChild(tr);

    tr.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        persistGradesFromDOM();
        updateCGPA();
      });
    });
  }

  function persistGradesFromDOM() {
    const rows = Array.from(document.querySelectorAll("#gradesTable tbody tr"));
    const grades = rows.map(tr => {
      const inputs = tr.querySelectorAll("input");
      return {
        code: inputs[0].value.trim(),
        name: inputs[1].value.trim(),
        credits: Number(inputs[2].value) || 0,
        grade: inputs[3].value.trim().toUpperCase()
      };
    });
    saveStoredGrades(grades);
  }

  function updateCGPA() {
    const grades = getStoredGrades();
    const rows = grades.map(g => ({ grade: g.grade, credits: g.credits }));
    const cgpa = calculateCGPA(rows);
    document.getElementById("cgpaValue").textContent = cgpa.toFixed(2);
  }

  // ------- Attendance summary + pie chart -------
  function getAttendanceStats(email) {
    const raw = localStorage.getItem(ATT_KEY);
    if (!raw) return { total: 0, present: 0, absent: 0 };
    const list = JSON.parse(raw);
    let total = 0;
    let present = 0;
    list.forEach(rec => {
      (rec.entries || []).forEach(e => {
        if (e.email === email) {
          total++;
          if (e.present) present++;
        }
      });
    });
    const absent = total - present;
    return { total, present, absent };
  }

  function initAttendance(auth) {
    const email = auth.email;
    const stats = getAttendanceStats(email);
    const summaryEl = document.getElementById("attSummary");

    if (!stats.total) {
      summaryEl.innerHTML = `
        <span class="text-secondary">No attendance data yet. Once faculty marks attendance, it will appear here.</span>
      `;
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      attendanceChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Present", "Absent"],
          datasets: [{ data: [0, 1] }]
        }
      });
      return;
    }

    const percentage = ((stats.present / stats.total) * 100).toFixed(1);
    summaryEl.innerHTML = `
      <div>Total classes: <strong>${stats.total}</strong></div>
      <div>Present: <strong>${stats.present}</strong> | Absent: <strong>${stats.absent}</strong></div>
      <div>Attendance %: <strong>${percentage}%</strong></div>
    `;

    const ctx = document.getElementById("attendanceChart").getContext("2d");
    attendanceChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["Present", "Absent"],
        datasets: [{ data: [stats.present, stats.absent] }]
      }
    });
  }

  // ------- Marks from faculty -------
  async function initMarks(auth) {
  const tbody = document.getElementById("marksTable");
  tbody.innerHTML = "";

  try {
    const res = await fetch(API_BASE + "/marks/me", {
      headers: {
        ...getAuthHeaders(),
      },
    });

    const data = await res.json();
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="4" class="small text-danger">Error loading marks.</td></tr>`;
      return;
    }

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="4" class="small text-secondary">No marks saved yet.</td></tr>`;
      return;
    }

    data.forEach((r) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.subject}</td>
        <td>${r.marks}</td>
        <td>${r.maxMarks}</td>
        <td>${r.grade}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="4" class="small text-danger">Error: ${err.message}</td></tr>`;
  }
}

  // ------- Projects -------
  function getProjects() {
    const raw = localStorage.getItem(STUDENT_PROJECTS_KEY);
    return raw ? JSON.parse(raw) : [];
  }

  function initProjects() {
    const listEl = document.getElementById("projectList");
    listEl.innerHTML = "";
    const projects = getProjects();
    if (!projects.length) {
      listEl.innerHTML = `<li class="list-group-item bg-transparent text-secondary">No active projects.</li>`;
      return;
    }
    projects.forEach(p => {
      const li = document.createElement("li");
      li.className = "list-group-item bg-transparent text-light d-flex justify-content-between";
      li.innerHTML = `
        <div>
          <div class="fw-semibold">${p.title}</div>
          <div class="small text-secondary">${p.subject}</div>
        </div>
        <div class="small text-warning">Due: ${p.deadline}</div>
      `;
      listEl.appendChild(li);
    });
  }

  // ------- Finance -------
  function getFinance() {
    const raw = localStorage.getItem(STUDENT_FINANCE_KEY);
    if (raw) return JSON.parse(raw);
    const demo = [
      { term: "Sem 5", fees: 60000, paid: 60000 },
      { term: "Sem 6", fees: 62000, paid: 30000 }
    ];
    localStorage.setItem(STUDENT_FINANCE_KEY, JSON.stringify(demo));
    return demo;
  }

  function initFinance() {
    const tbody = document.getElementById("financeTable");
    tbody.innerHTML = "";
    getFinance().forEach(r => {
      const due = r.fees - r.paid;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.term}</td>
        <td>‚Çπ${r.fees}</td>
        <td>‚Çπ${r.paid}</td>
        <td class="${due > 0 ? "text-danger" : "text-success"}">‚Çπ${due}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ------- Events -------
  function getEvents() {
    const raw = localStorage.getItem(EVENTS_KEY);
    return raw ? JSON.parse(raw) : [];
  }

  function initEvents() {
    const ul = document.getElementById("eventList");
    ul.innerHTML = "";
    const list = getEvents();
    if (!list.length) {
      ul.innerHTML = `<li class="list-group-item bg-transparent text-secondary">No events posted yet.</li>`;
      return;
    }
    list.forEach(e => {
      const li = document.createElement("li");
      li.className = "list-group-item bg-transparent text-light d-flex justify-content-between";
      li.innerHTML = `
        <div>
          <div class="fw-semibold">${e.title}</div>
          <div class="small text-secondary">${e.description || ""}</div>
        </div>
        <div class="text-end small">
          <div class="text-info">${e.date}</div>
          <div class="text-secondary">${e.targetDept || "ALL"}</div>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  // ------- Navigation helpers -------
  function openAttendanceDetails() {
    alert("Later you can show detailed date-wise attendance table here.");
  }
  function openProjects() {
    window.scrollTo({ top: document.getElementById("projectList").offsetTop - 80, behavior: "smooth" });
  }
  function openFinance() {
    window.scrollTo({ top: document.getElementById("financeTable").offsetTop - 80, behavior: "smooth" });
  }
  function scrollToEvents() {
    window.scrollTo({ top: document.getElementById("eventsSection").offsetTop - 80, behavior: "smooth" });
  }
  function openChat() {
    window.location.href = "chat.html";
  }
</script>
</body>
</html>
